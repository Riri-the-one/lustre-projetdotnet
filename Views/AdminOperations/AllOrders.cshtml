@model IEnumerable<Order>
@{
	Layout = "_AdminLayout";
	ViewData["Title"] = "All Orders";
}

<style>
	.orders-layout {
		display: grid;
		grid-template-columns: 350px 280px 1fr;
		gap: 20px;
		height: calc(100vh - 200px);
		min-height: 600px;
	}

	.orders-list-panel {
		background: linear-gradient(135deg, #FFFFFF 0%, #FEFCF9 100%);
		border-radius: 20px;
		padding: 20px;
		box-shadow: 0 4px 20px rgba(61, 40, 23, 0.08);
		border: 1px solid rgba(232, 213, 196, 0.3);
		overflow-y: auto;
	}

	.orders-list-header {
		font-family: 'Playfair Display', serif;
		font-size: 24px;
		font-weight: 400;
		color: var(--dark-brown);
		font-style: italic;
		margin-bottom: 20px;
		padding-bottom: 15px;
		border-bottom: 2px solid rgba(232, 213, 196, 0.5);
	}

	.order-item {
		background: var(--white);
		border-radius: 12px;
		padding: 16px;
		margin-bottom: 12px;
		cursor: pointer;
		transition: all 0.3s ease;
		border: 2px solid transparent;
		box-shadow: 0 2px 8px rgba(61, 40, 23, 0.05);
	}

	.order-item:hover {
		transform: translateX(5px);
		box-shadow: 0 4px 16px rgba(61, 40, 23, 0.12);
		border-color: rgba(232, 213, 196, 0.6);
	}

	.order-item.active {
		background: linear-gradient(135deg, rgba(232, 213, 196, 0.2) 0%, rgba(232, 213, 196, 0.1) 100%);
		border-color: var(--light-brown);
		box-shadow: 0 4px 20px rgba(139, 111, 71, 0.2);
	}

	.order-item-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 10px;
	}

	.order-id {
		font-weight: 600;
		color: var(--dark-brown);
		font-size: 16px;
	}

	.order-date {
		font-size: 12px;
		color: var(--light-brown);
	}

	.order-customer {
		font-size: 14px;
		color: var(--text-dark);
		margin-bottom: 8px;
		font-weight: 500;
	}

	.order-amount {
		font-size: 18px;
		font-weight: 600;
		color: var(--light-brown);
		font-family: 'Playfair Display', serif;
	}

	.status-panel {
		background: linear-gradient(135deg, #FFFFFF 0%, #FEFCF9 100%);
		border-radius: 20px;
		padding: 20px;
		box-shadow: 0 4px 20px rgba(61, 40, 23, 0.08);
		border: 1px solid rgba(232, 213, 196, 0.3);
		overflow-y: auto;
	}

	.status-panel-header {
		font-family: 'Playfair Display', serif;
		font-size: 24px;
		font-weight: 400;
		color: var(--dark-brown);
		font-style: italic;
		margin-bottom: 20px;
		padding-bottom: 15px;
		border-bottom: 2px solid rgba(232, 213, 196, 0.5);
	}

	.status-badge-container {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.status-badge {
		padding: 14px 18px;
		border-radius: 12px;
		font-size: 14px;
		font-weight: 600;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s ease;
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}

	.status-badge:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}

	.status-badge.active {
		transform: scale(1.05);
		box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
	}

	.status-badge.pending {
		background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
		color: #856404;
		border: 2px solid #ffc107;
	}

	.status-badge.approved {
		background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
		color: #0c5460;
		border: 2px solid #17a2b8;
	}

	.status-badge.shipped {
		background: linear-gradient(135deg, #cce5ff 0%, #b3d9ff 100%);
		color: #004085;
		border: 2px solid #007bff;
	}

	.status-badge.delivered {
		background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
		color: #155724;
		border: 2px solid #28a745;
	}

	.status-badge.cancelled {
		background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
		color: #721c24;
		border: 2px solid #dc3545;
	}

	.status-icon {
		font-size: 18px;
	}

	.details-panel {
		background: linear-gradient(135deg, #FFFFFF 0%, #FEFCF9 100%);
		border-radius: 20px;
		padding: 30px;
		box-shadow: 0 4px 20px rgba(61, 40, 23, 0.08);
		border: 1px solid rgba(232, 213, 196, 0.3);
		overflow-y: auto;
	}

	.details-panel-header {
		font-family: 'Playfair Display', serif;
		font-size: 28px;
		font-weight: 400;
		color: var(--dark-brown);
		font-style: italic;
		margin-bottom: 25px;
		padding-bottom: 15px;
		border-bottom: 2px solid rgba(232, 213, 196, 0.5);
	}

	.detail-section {
		margin-bottom: 30px;
	}

	.detail-section-title {
		font-size: 16px;
		font-weight: 600;
		color: var(--light-brown);
		text-transform: uppercase;
		letter-spacing: 1px;
		margin-bottom: 15px;
	}

	.detail-row {
		display: flex;
		justify-content: space-between;
		padding: 12px 0;
		border-bottom: 1px solid rgba(232, 213, 196, 0.3);
	}

	.detail-label {
		font-weight: 600;
		color: var(--text-dark);
	}

	.detail-value {
		color: var(--dark-brown);
		text-align: right;
	}

	.order-items-table {
		width: 100%;
		border-collapse: collapse;
		margin-top: 15px;
	}

	.order-items-table th {
		background: linear-gradient(135deg, var(--dark-brown) 0%, #8B6F47 100%);
		color: white;
		padding: 12px;
		text-align: left;
		font-weight: 600;
		font-size: 14px;
	}

	.order-items-table td {
		padding: 12px;
		border-bottom: 1px solid rgba(232, 213, 196, 0.3);
		color: var(--text-dark);
	}

	.order-items-table tr:hover {
		background-color: rgba(232, 213, 196, 0.1);
	}

	.action-buttons {
		display: flex;
		gap: 10px;
		margin-top: 25px;
		flex-wrap: wrap;
	}

	.action-btn {
		padding: 10px 20px;
		border-radius: 8px;
		border: none;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		display: inline-flex;
		align-items: center;
		gap: 8px;
		text-decoration: none;
	}

	.action-btn-primary {
		background: linear-gradient(135deg, var(--dark-brown) 0%, #8B6F47 100%);
		color: white;
	}

	.action-btn-primary:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(61, 40, 23, 0.3);
	}

	.action-btn-info {
		background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
		color: white;
	}

	.action-btn-info:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
	}

	.action-btn-warning {
		background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
		color: #856404;
	}

	.action-btn-warning:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
	}

	.empty-state {
		text-align: center;
		padding: 60px 20px;
		color: var(--text-dark);
	}

	.empty-state-icon {
		font-size: 64px;
		color: var(--light-brown);
		opacity: 0.5;
		margin-bottom: 20px;
	}

	.empty-state-text {
		font-size: 18px;
		color: var(--text-dark);
	}

	.status-select {
		flex: 1;
		min-width: 200px;
		padding: 10px 15px;
		border-radius: 8px;
		border: 1px solid rgba(232, 213, 196, 0.5);
		background: white;
		font-size: 14px;
		color: var(--text-dark);
		cursor: pointer;
		transition: all 0.3s ease;
		font-family: inherit;
	}

	.status-select:hover {
		border-color: var(--light-brown);
		box-shadow: 0 2px 8px rgba(61, 40, 23, 0.1);
	}

	.status-select:focus {
		outline: none;
		border-color: var(--dark-brown);
		box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
	}

	.status-update-btn {
		padding: 10px 24px;
		white-space: nowrap;
		border: none;
		border-radius: 8px;
		background: linear-gradient(135deg, var(--dark-brown) 0%, #8B6F47 100%);
		color: white;
		font-weight: 600;
		font-size: 14px;
		cursor: pointer;
		transition: all 0.3s ease;
		display: inline-flex;
		align-items: center;
		gap: 8px;
	}

	.status-update-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(61, 40, 23, 0.3);
	}

	.status-message {
		margin-top: 8px;
		font-size: 12px;
		font-weight: 500;
		padding: 4px 8px;
		border-radius: 4px;
	}

	@@media (max-width: 1400px) {
		.orders-layout {
			grid-template-columns: 300px 250px 1fr;
		}
	}

	@@media (max-width: 1200px) {
		.orders-layout {
			grid-template-columns: 1fr;
			height: auto;
		}

		.orders-list-panel,
		.status-panel,
		.details-panel {
			height: 400px;
		}
	}
</style>

<div style="max-width: 1600px; margin: 0 auto;">
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
		<h2 style="font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 400; color: var(--dark-brown); font-style: italic; margin: 0;">Orders Management</h2>
	</div>

	@if (Model != null && Model.Count() > 0)
	{
		<div class="orders-layout">
			<!-- Left Panel: Orders List -->
			<div class="orders-list-panel">
				<div class="orders-list-header">Orders</div>
				<div id="ordersList">
					@foreach (var order in Model)
					{
						var totalAmount = order.OrderDetails?.Sum(od => od.Quantity * od.UnitPrice) ?? 0;
						<div class="order-item" data-order-id="@order.Id" onclick="selectOrder(@order.Id)">
							<div class="order-item-header">
								<span class="order-id">#@order.Id</span>
								<span class="order-date">@order.CreateDate.ToString("dd MMM yyyy")</span>
							</div>
							<div class="order-customer">@order.Name</div>
							<div class="order-amount">@totalAmount.ToString("N2") MAD</div>
						</div>
					}
				</div>
			</div>

			<!-- Middle Panel: Status Column -->
			<div class="status-panel">
				<div class="status-panel-header">STATUTS</div>
				<div class="status-badge-container" id="statusContainer">
					@{
						var allStatuses = Model.SelectMany(o => new[] { o.OrderStatus }).DistinctBy(s => s?.Id).ToList();
						var statusNames = new[] { "Pending", "Approved", "Shipped", "Delivered", "Cancelled" };
					}
					@foreach (var statusName in statusNames)
					{
						var statusClass = statusName.ToLower();
						var icon = statusName switch
						{
							"Pending" => "bi-clock-history",
							"Approved" => "bi-check-circle",
							"Shipped" => "bi-truck",
							"Delivered" => "bi-check2-all",
							"Cancelled" => "bi-x-circle",
							_ => "bi-circle"
						};
						<div class="status-badge @statusClass" data-status="@statusName" onclick="filterByStatus('@statusName')">
							<i class="bi @icon status-icon"></i>
							<span>@statusName</span>
						</div>
					}
				</div>
			</div>

			<!-- Right Panel: Order Details -->
			<div class="details-panel" id="detailsPanel">
				<div class="empty-state">
					<i class="bi bi-inbox empty-state-icon"></i>
					<div class="empty-state-text">Select an order to view details</div>
				</div>
			</div>
		</div>

		<!-- Store order data for JavaScript -->
		<script>
			const ordersData = {
				@foreach (var order in Model)
				{
					var totalAmount = order.OrderDetails?.Sum(od => od.Quantity * od.UnitPrice) ?? 0;
					<text>
					@order.Id: {
						id: @order.Id,
						date: "@order.CreateDate.ToString("dd MMM yyyy HH:mm")",
						name: "@order.Name",
						email: "@order.Email",
						mobile: "@order.MobileNumber",
						address: "@order.Address",
						paymentMethod: "@order.PaymentMethod",
						isPaid: @order.IsPaid.ToString().ToLower(),
						status: "@order.OrderStatus?.StatusName",
						statusId: @order.OrderStatusId,
						totalAmount: @totalAmount,
						items: [
							@foreach (var item in order.OrderDetails ?? new List<OrderDetail>())
							{
								<text>
								{
									productName: "@item.Product?.ProductName",
									category: "@item.Product?.Category?.CategoryName",
									price: @item.UnitPrice,
									quantity: @item.Quantity,
									total: @(item.Quantity * item.UnitPrice)
								},
								</text>
							}
						]
					},
					</text>
				}
			};

			const availableStatuses = [
				@foreach (var status in ViewBag.OrderStatuses as IEnumerable<dynamic> ?? new List<dynamic>())
				{
					<text>
					{ id: @status.Id, name: "@status.Name" },
					</text>
				}
			];
		</script>
	}
	else
	{
		<div style="background: linear-gradient(135deg, #FFFFFF 0%, #FEFCF9 100%); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 4px 20px rgba(61, 40, 23, 0.08); border: 1px solid rgba(232, 213, 196, 0.3);">
			<h4 style="font-family: 'Playfair Display', serif; color: var(--dark-brown); margin-bottom: 15px;">No orders found</h4>
			<p style="color: var(--text-dark);">There are no orders to display at this time.</p>
		</div>
	}
</div>

<script>
	let selectedOrderId = null;
	let selectedStatus = null;

	function selectOrder(orderId) {
		selectedOrderId = orderId;
		
		// Update active state
		document.querySelectorAll('.order-item').forEach(item => {
			item.classList.remove('active');
		});
		document.querySelector(`[data-order-id="${orderId}"]`).classList.add('active');
		
		// Update status badges
		const order = ordersData[orderId];
		if (order) {
			document.querySelectorAll('.status-badge').forEach(badge => {
				badge.classList.remove('active');
				if (badge.dataset.status === order.status) {
					badge.classList.add('active');
				}
			});
		}
		
		// Render details
		renderOrderDetails(order);
	}

	function filterByStatus(statusName) {
		selectedStatus = statusName;
		
		// Update active state
		document.querySelectorAll('.status-badge').forEach(badge => {
			badge.classList.remove('active');
		});
		document.querySelector(`[data-status="${statusName}"]`).classList.add('active');
		
		// Filter orders
		document.querySelectorAll('.order-item').forEach(item => {
			const orderId = parseInt(item.dataset.orderId);
			const order = ordersData[orderId];
			if (order && order.status === statusName) {
				item.style.display = 'block';
			} else {
				item.style.display = 'none';
			}
		});
		
		// Clear details if no order matches
		if (!selectedOrderId || ordersData[selectedOrderId].status !== statusName) {
			document.getElementById('detailsPanel').innerHTML = `
				<div class="empty-state">
					<i class="bi bi-filter-circle empty-state-icon"></i>
					<div class="empty-state-text">No orders with status "${statusName}"</div>
				</div>
			`;
		}
	}

	function renderOrderDetails(order) {
		if (!order) return;
		
		const statusClass = order.status.toLowerCase();
		const statusColors = {
			pending: '#ffc107',
			approved: '#17a2b8',
			shipped: '#007bff',
			delivered: '#28a745',
			cancelled: '#dc3545'
		};
		
		const detailsHtml = `
			<div class="details-panel-header">Order #${order.id}</div>
			
			<div class="detail-section">
				<div class="detail-section-title">Customer Information</div>
				<div class="detail-row">
					<span class="detail-label">Name:</span>
					<span class="detail-value">${order.name}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Email:</span>
					<span class="detail-value">${order.email}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Mobile:</span>
					<span class="detail-value">${order.mobile}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Address:</span>
					<span class="detail-value">${order.address}</span>
				</div>
			</div>
			
			<div class="detail-section">
				<div class="detail-section-title">Order Information</div>
				<div class="detail-row">
					<span class="detail-label">Date:</span>
					<span class="detail-value">${order.date}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Status:</span>
					<span class="detail-value">
						<span id="current-status-badge" class="status-badge ${statusClass}" style="display: inline-block; padding: 6px 12px; font-size: 12px;">
							${order.status}
						</span>
					</span>
				</div>
				<div class="detail-row" style="margin-top: 15px;">
					<span class="detail-label">Update Status:</span>
					<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 8px;">
						<select id="status-select-${order.id}" class="status-select">
							${availableStatuses.map(s => `
								<option value="${s.id}" ${s.id === order.statusId ? 'selected' : ''}>${s.name}</option>
							`).join('')}
						</select>
						<button onclick="updateOrderStatus(${order.id})" class="status-update-btn">
							<i class="bi bi-check-lg"></i> Update
						</button>
					</div>
					<div id="status-update-message-${order.id}" class="status-message"></div>
				</div>
				<div class="detail-row">
					<span class="detail-label">Payment Method:</span>
					<span class="detail-value">${order.paymentMethod}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Payment Status:</span>
					<span class="detail-value">
						<span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; ${order.isPaid ? 'background: #d4edda; color: #155724;' : 'background: #fff3cd; color: #856404;'}">
							${order.isPaid ? 'Paid' : 'Not Paid'}
						</span>
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Total Amount:</span>
					<span class="detail-value" style="font-size: 20px; font-weight: 600; color: var(--light-brown);">${order.totalAmount.toFixed(2)} MAD</span>
				</div>
			</div>
			
			<div class="detail-section">
				<div class="detail-section-title">Order Items</div>
				<table class="order-items-table">
					<thead>
						<tr>
							<th>Product</th>
							<th>Category</th>
							<th>Price</th>
							<th>Qty</th>
							<th>Total</th>
						</tr>
					</thead>
					<tbody>
						${order.items.map(item => `
							<tr>
								<td>${item.productName}</td>
								<td>${item.category}</td>
								<td>${item.price.toFixed(2)} MAD</td>
								<td>${item.quantity}</td>
								<td>${item.total.toFixed(2)} MAD</td>
							</tr>
						`).join('')}
					</tbody>
				</table>
			</div>
			
			<div class="action-buttons">
				<a href="/AdminOperations/TogglePaymentStatus?orderId=${order.id}" class="action-btn action-btn-warning">
					<i class="bi bi-credit-card"></i> Toggle Payment
				</a>
			</div>
		`;
		
		document.getElementById('detailsPanel').innerHTML = detailsHtml;
	}

	function updateOrderStatus(orderId) {
		const selectElement = document.getElementById(`status-select-${orderId}`);
		const messageElement = document.getElementById(`status-update-message-${orderId}`);
		
		if (!selectElement || !messageElement) return;
		
		const newStatusId = parseInt(selectElement.value);
		const order = ordersData[orderId];
		
		if (!order || order.statusId === newStatusId) {
			messageElement.textContent = 'Status is already set to this value';
			messageElement.style.color = '#856404';
			setTimeout(() => messageElement.textContent = '', 3000);
			return;
		}
		
		// Show loading message
		messageElement.textContent = 'Updating...';
		messageElement.style.color = '#17a2b8';
		
		// Make AJAX request
		fetch('/AdminOperations/UpdateOrderStatusAjax', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				orderId: orderId,
				orderStatusId: newStatusId
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				// Update order data
				order.statusId = data.newStatusId;
				order.status = data.newStatus;
				
				// Update UI
				const statusBadge = document.getElementById('current-status-badge');
				if (statusBadge) {
					const statusClass = data.newStatus.toLowerCase();
					statusBadge.className = `status-badge ${statusClass}`;
					statusBadge.textContent = data.newStatus;
					
					// Update status badge colors
					const statusColors = {
						pending: '#ffc107',
						approved: '#17a2b8',
						shipped: '#007bff',
						delivered: '#28a745',
						cancelled: '#dc3545'
					};
					statusBadge.style.background = statusColors[statusClass] || '#6c757d';
					statusBadge.style.color = 'white';
				}
				
				// Update status badges in middle panel
				document.querySelectorAll('.status-badge').forEach(badge => {
					badge.classList.remove('active');
					if (badge.dataset.status === data.newStatus) {
						badge.classList.add('active');
					}
				});
				
				// Update order item in left panel if status is visible
				const orderItem = document.querySelector(`[data-order-id="${orderId}"]`);
				if (orderItem) {
					// Refresh order list to reflect status change
					// The order might need to be moved or highlighted differently
				}
				
				messageElement.textContent = 'Status updated successfully!';
				messageElement.style.color = '#28a745';
				
				// Reload page after 1 second to refresh all data
				setTimeout(() => {
					window.location.reload();
				}, 1000);
			} else {
				messageElement.textContent = data.message || 'Failed to update status';
				messageElement.style.color = '#dc3545';
			}
		})
		.catch(error => {
			console.error('Error:', error);
			messageElement.textContent = 'An error occurred while updating status';
			messageElement.style.color = '#dc3545';
		})
		.finally(() => {
			setTimeout(() => {
				messageElement.textContent = '';
			}, 5000);
		});
	}

	// Select first order by default
	document.addEventListener('DOMContentLoaded', function() {
		const firstOrder = document.querySelector('.order-item');
		if (firstOrder) {
			const orderId = parseInt(firstOrder.dataset.orderId);
			selectOrder(orderId);
		}
	});
</script>
